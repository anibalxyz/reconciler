services:
  api:
    pull_policy: never
    volumes:
      # Mount source code and config for manual reload by restarting the container
      - ./backend/api/pom.xml:/app/pom.xml:cached
      - ./backend/api/src:/app/src:cached
      # Persist Maven dependencies cache to speed up builds
      - maven:/root/.m2

  dashboard:
    image: anibalxyz/reconciler-dev-dashboard:latest
    pull_policy: never
    container_name: reconciler-dev-dashboard
    env_file:
      - ./frontend/.env.dev
    environment:
      - APP_ENV=${APP_ENV}
    ports:
      - "${DASHBOARD_PORT}:${DASHBOARD_PORT}"
    volumes:
      # Enables hot reload by mounting source code and config files
      - ./frontend/dashboard/src:/app/dashboard/src:cached
      - ./frontend/dashboard/index.html:/app/dashboard/index.html:cached
      - ./frontend/dashboard/package.json:/app/dashboard/package.json:cached
      - ./frontend/dashboard/tsconfig.json:/app/dashboard/tsconfig.json:cached
      - ./frontend/dashboard/vite.config.ts:/app/dashboard/vite.config.ts:cached
      # Base frontend/ files
      - ./frontend/.env.dev:/app/.env.dev:cached
      - ./frontend/package.json:/app/package.json:cached
      - ./frontend/tsconfig.base.json:/app/tsconfig.base.json:cached
      - ./frontend/vite.config.ts:/app/vite.config.ts:cached
      - ./frontend/common:/app/common:cached
      # Cache subfrontend-specific node_modules
      - dashboard-node_modules:/app/node_modules:cached

    networks:
      - main

  public-site:
    image: anibalxyz/reconciler-dev-public-site:latest
    pull_policy: never
    container_name: reconciler-dev-public-site
    env_file:
      - ./frontend/.env.dev
    environment:
      - APP_ENV=${APP_ENV}
    ports:
      - "${PUBLIC_SITE_PORT}:${PUBLIC_SITE_PORT}"
    volumes:
      # Enables hot reload by mounting source code and config files
      - ./frontend/public-site/src:/app/public-site/src:cached
      - ./frontend/public-site/package.json:/app/public-site/package.json:cached
      - ./frontend/public-site/tsconfig.json:/app/public-site/tsconfig.json:cached
      - ./frontend/public-site/astro.config.ts:/app/public-site/astro.config.ts:cached
      # Base frontend/ files
      - ./frontend/.env.dev:/app/.env.dev:cached
      - ./frontend/package.json:/app/package.json:cached
      - ./frontend/tsconfig.base.json:/app/tsconfig.base.json:cached
      - ./frontend/vite.config.ts:/app/vite.config.ts:cached
      - ./frontend/common:/app/common:cached
      # Cache subfrontend-specific node_modules
      - public-site-node_modules:/app/node_modules:cached
    networks:
      - main

volumes:
  maven:
    name: "reconciler-dev-mvn"
  dashboard-node_modules:
    name: "reconciler-dev-dashboard-node"
  public-site-node_modules:
    name: "reconciler-dev-public-site-node"
